<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><title>Returning empty interfaces in Golang | Arjun Mahishi</title><link rel="icon" href="/favicon.ico"/><meta name="description" content="Arjun Mahishi&#x27;s personal website"/><meta property="og:title" content="Returning empty interfaces in Golang"/><meta property="og:description" content=""/><meta property="og:image" content="/img/dp.jpg"/><meta property="og:url" content="https://arjunmahishi.me"/><meta property="og:type" content="blog"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content="@arjunmahishi"/><meta name="twitter:creator" content="@arjunmahishi"/><meta name="twitter:title" content="Returning empty interfaces in Golang"/><meta name="twitter:description" content=""/><meta name="twitter:image" content="/img/dp.jpg"/><link rel="preload" href="https://unpkg.com/prismjs@0.0.1/themes/prism-okaidia.css" as="script"/><link href="/gruvbox.css" rel="stylesheet"/><meta name="next-head-count" content="18"/><link rel="preload" href="/_next/static/css/1e7eac4066826e90.css" as="style"/><link rel="stylesheet" href="/_next/static/css/1e7eac4066826e90.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-8fa1640cc84ba8fe.js" defer=""></script><script src="/_next/static/chunks/framework-2c79e2a64abdb08b.js" defer=""></script><script src="/_next/static/chunks/main-481ef0d25a716735.js" defer=""></script><script src="/_next/static/chunks/pages/_app-8eb925bbcba34840.js" defer=""></script><script src="/_next/static/chunks/209-e125b2166f138b3f.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-37326ba3161f0a7d.js" defer=""></script><script src="/_next/static/uwdC6iWM-7ud-pXpO8LKL/_buildManifest.js" defer=""></script><script src="/_next/static/uwdC6iWM-7ud-pXpO8LKL/_ssgManifest.js" defer=""></script></head><body><div id="__next">  <div class="grid place-items-center"><div class="flex flex-col items-center"><h1 class="text-center text-4xl font-bold mb-4"><a class="underline decoration-2 underline-offset-4" href="/">ಅರ್ಜುನ್ ಮಹಿಷಿ</a></h1><nav><ul class="flex flex-wrap justify-center gap-2"><li class="mx-2 inline-block align-text-bottom"><a class="underline underline-offset-4 decoration-2" href="/about">About</a></li><li class="mx-2 inline-block align-text-bottom"><a class="underline underline-offset-4 decoration-2" href="/projects">Projects</a></li><li class="mx-2 inline-block align-text-bottom"><a class="underline underline-offset-4 decoration-2" href="/posts">Blog</a></li><li class="mx-2 inline-block align-text-bottom"><a class="underline underline-offset-4 decoration-2" href="/vim-adventures">Vim-Adventures</a></li><li class="mx-2 inline-block align-text-bottom"><a class="underline underline-offset-4 decoration-2" href="/maps">Maps</a></li></ul></nav></div><div class="prose lg:max-w-2xl lg:prose-lg px-8 m-auto my-4 sm:my-16 prose-img:rounded-xl"><h1 class="">Returning empty interfaces in Golang</h1></div><img alt="Returning empty interfaces in Golang" class="lg:max-w-3xl rounded-xl" style="display:none"/><article class="prose lg:max-w-2xl lg:prose-lg px-8 m-auto my-4 sm:my-16 prose-img:rounded-xl"><html><head></head><body><p><img src="https://i.imgur.com/qX0N1Bg.png" alt="returning-empty-interfaces-golang"></p>
<p>This week I ran into a bug with an empty <code>interface{}</code> which highlighted a smell in the code. This post describes what the bug is, how I fixed it, and the lessons learned.</p>
<h3 id="the-bug"><a class="anchor" href="#the-bug">The Bug</a></h3>
<p>We found a couple of recovered panics in the logs. These panics were happening pretty frequently. This is what the panic message said:</p>
<blockquote>
<p>panic: interface conversion: interface {} is <code>nil</code>, not []*typeName</p>
</blockquote>
<p>From the panic message, it is pretty obvious that somewhere in the code we are trying to convert an <code>interface{}</code> to a specific array type when the value is actually <code>nil</code>. And the panic message also has a trace to the exact line where this conversion is taking place. This is a very common error and is easy to fix. But while debugging this, I encountered a smell in the code that led to this in the first place. This is what the code kind of looked like:</p>
<p>There is an interface with a single method which returns <code>interface{}</code></p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">type</span> I <span class="token keyword">interface</span> <span class="token punctuation">{</span>
  <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>There are two structs (<code>impl1</code> and <code>impl2</code>) that implement the above interface</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// impl1 implements I</span>
<span class="token keyword">type</span> impl1 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i impl1<span class="token punctuation">)</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token comment">// impl2 implements I</span>
<span class="token keyword">type</span> impl2 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i impl2<span class="token punctuation">)</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> i<span class="token punctuation">.</span><span class="token function">helper</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i impl2<span class="token punctuation">)</span> <span class="token function">helper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token builtin">int</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>What do you think will be the output of the below code?</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> A<span class="token punctuation">,</span> B I

  A <span class="token operator">=</span> impl1<span class="token punctuation">{</span><span class="token punctuation">}</span>
  B <span class="token operator">=</span> impl2<span class="token punctuation">{</span><span class="token punctuation">}</span>

  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>A<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// statement 1</span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>B<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// statement 2</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>As you can probably guess, <code>statement 1</code> panics and <code>statement 2</code> never gets executed. But what if <code>statement 1</code> wasn't there. What do you think would happen then?</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> B I

  B <span class="token operator">=</span> impl2<span class="token punctuation">{</span><span class="token punctuation">}</span>

  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>B<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>Would this code panic?</p>
<p>It wouldn't. This code actually prints <code>[]</code> (empty slice). This can be made more clear by printing the <code>type</code> of the return values.</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> A<span class="token punctuation">,</span> B I

  A <span class="token operator">=</span> impl1<span class="token punctuation">{</span><span class="token punctuation">}</span>
  B <span class="token operator">=</span> impl2<span class="token punctuation">{</span><span class="token punctuation">}</span>

  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>A<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// prints "&#x3C;nil>"</span>
  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>reflect<span class="token punctuation">.</span><span class="token function">TypeOf</span><span class="token punctuation">(</span>B<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// prints "[]*int"</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>This is because when you assign <code>nil</code> to a slice in go, it releases the underlying array to the garbage collector and resets the slice to its "zero value". Empty slices are treated the same as <code>nil</code>.</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">var</span> arr <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
arr <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token comment">// evaluates to true</span>
</code></pre></div>
<p>Since the <code>helper()</code> method of the struct <code>impl2</code> has the return type as <code>[]*int</code>, the <code>nil</code> returned aquires the type <code>[]*int</code> with "zero value"</p>
<h3 id="the-fix"><a class="anchor" href="#the-fix">The Fix</a></h3>
<p>There are a couple of obvious fixes for this. The quick way is, The <code>fun()</code> method of <code>impl1</code> should not return <code>nil</code>. Instead, it should return an empty slice.</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">type</span> impl1 <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>i impl1<span class="token punctuation">)</span> <span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> arr <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token builtin">int</span>
  <span class="token keyword">return</span> arr
<span class="token punctuation">}</span>
</code></pre></div>
<p>Alternatively, you could also check if the value is nil before trying to typecast it.</p>
<div class="remark-highlight"><pre class="language-go"><code class="language-go"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> A I

  A <span class="token operator">=</span> impl1<span class="token punctuation">{</span><span class="token punctuation">}</span>

  result <span class="token operator">:=</span> A<span class="token punctuation">.</span><span class="token function">fun</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">if</span> result <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
    <span class="token comment">// return an error or handle it any other way</span>
  <span class="token punctuation">}</span>

  fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div>
<p>The <strong>right way</strong>, is to consider re-writing this part of the code. The interface should be given another thought.</p>
<h3 id="lessons-learnt"><a class="anchor" href="#lessons-learnt">Lessons learnt</a></h3>
<p>It is very convenient to use <code>interface{}</code> where we want to <strong>allow any type</strong>. But it can cause a lot of unpredictable behavior. The empty interface is not a feature, it's a side effect of another feature which is the <em>implicit implementation of interfaces</em>. Since <code>interface{}</code> has no methods in it, every object in golang can conform to it.</p>
<p>Sure, it can be useful when you want to <strong>accept any type</strong> to be passed as an argument to a function (like in <code>fmt.Println</code> and many others). It works out in this case because the treatment of the value passed is in the hands of the author of the function. If you are writing such a function, you would know exactly what kind of types to expect, and how to handle unexpected types. But when the function returns an empty <code>interface{}</code>, the user of the function has no idea of all the possible types that can come out. They will only know what type they expect and only handle that (leading to situations like the above).</p>
<p>The <strong>need</strong> to even return an empty interface exposes a design flaw in the code. In fact, returning <strong>any interface</strong> is probably not a good idea.</p>
<blockquote>
<p>interface{} says nothing</p>
</blockquote>
<p>See what <a href="https://en.wikipedia.org/wiki/Rob_Pike">Rob Pike</a> has to say about it (the video will start from a specific time, but watch the whole video when you get a chance):</p>
<p>{{&#x3C; youtube "PAAkCSZUG1c?start=455" >}}
<br></p>
<p>So, return a concrete type unless it's absolutely necessary to return an interface. In the above case, what could possibly be the reason to use an empty <code>interface{}</code>? <code>impl1</code> and <code>impl2</code> might return different types? Then, in that case, they shouldn't really conform to the same interface. There is almost always a way to <strong>not</strong> use an empty <code>interface{}</code></p>
<p>Hope this post was interesting. If you have any suggestions/corrections, consider <a href="https://github.com/arjunmahishi/arjunmahishi.github.io/edit/master/content/posts/returning-interface-golang.md">making a PR</a> :) or you can also slide into my <a href="https://twitter.com/messages/131552332-131552332?text=hi">Twitter DM</a></p>
</body></html></article></div><footer class="text-center text-gray-500 text-sm mt-5 pb-2">Built from scratch with <!-- --> <a class="underline decoration-dashed underline-offset-4 decoration-2" href="https://nextjs.org/">Next.js</a> and <!-- --> <a class="underline decoration-dashed underline-offset-4 decoration-2" href="https://tailwindcss.com/">Tailwind CSS</a></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"empty-interfaces-golang","contentHTML":"\u003chtml\u003e\u003chead\u003e\u003c/head\u003e\u003cbody\u003e\u003cp\u003e\u003cimg src=\"https://i.imgur.com/qX0N1Bg.png\" alt=\"returning-empty-interfaces-golang\"\u003e\u003c/p\u003e\n\u003cp\u003eThis week I ran into a bug with an empty \u003ccode\u003einterface{}\u003c/code\u003e which highlighted a smell in the code. This post describes what the bug is, how I fixed it, and the lessons learned.\u003c/p\u003e\n\u003ch3 id=\"the-bug\"\u003e\u003ca class=\"anchor\" href=\"#the-bug\"\u003eThe Bug\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eWe found a couple of recovered panics in the logs. These panics were happening pretty frequently. This is what the panic message said:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003epanic: interface conversion: interface {} is \u003ccode\u003enil\u003c/code\u003e, not []*typeName\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eFrom the panic message, it is pretty obvious that somewhere in the code we are trying to convert an \u003ccode\u003einterface{}\u003c/code\u003e to a specific array type when the value is actually \u003ccode\u003enil\u003c/code\u003e. And the panic message also has a trace to the exact line where this conversion is taking place. This is a very common error and is easy to fix. But while debugging this, I encountered a smell in the code that led to this in the first place. This is what the code kind of looked like:\u003c/p\u003e\n\u003cp\u003eThere is an interface with a single method which returns \u003ccode\u003einterface{}\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e I \u003cspan class=\"token keyword\"\u003einterface\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token function\"\u003efun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003einterface\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThere are two structs (\u003ccode\u003eimpl1\u003c/code\u003e and \u003ccode\u003eimpl2\u003c/code\u003e) that implement the above interface\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// impl1 implements I\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e impl1 \u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei impl1\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003efun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003einterface\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token comment\"\u003e// impl2 implements I\u003c/span\u003e\n\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e impl2 \u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei impl2\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003efun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003einterface\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e i\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ehelper\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei impl2\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003ehelper\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token builtin\"\u003eint\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWhat do you think will be the output of the below code?\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003emain\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e A\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e B I\n\n  A \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e impl1\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  B \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e impl2\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  fmt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eA\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token builtin\"\u003eint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// statement 1\u003c/span\u003e\n  fmt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eB\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token builtin\"\u003eint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// statement 2\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAs you can probably guess, \u003ccode\u003estatement 1\u003c/code\u003e panics and \u003ccode\u003estatement 2\u003c/code\u003e never gets executed. But what if \u003ccode\u003estatement 1\u003c/code\u003e wasn't there. What do you think would happen then?\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003emain\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e B I\n\n  B \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e impl2\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  fmt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eB\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token builtin\"\u003eint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eWould this code panic?\u003c/p\u003e\n\u003cp\u003eIt wouldn't. This code actually prints \u003ccode\u003e[]\u003c/code\u003e (empty slice). This can be made more clear by printing the \u003ccode\u003etype\u003c/code\u003e of the return values.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003emain\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e A\u003cspan class=\"token punctuation\"\u003e,\u003c/span\u003e B I\n\n  A \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e impl1\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n  B \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e impl2\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  fmt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ereflect\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eTypeOf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eA\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// prints \"\u0026#x3C;nil\u003e\"\u003c/span\u003e\n  fmt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ereflect\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003eTypeOf\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eB\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// prints \"[]*int\"\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThis is because when you assign \u003ccode\u003enil\u003c/code\u003e to a slice in go, it releases the underlying array to the garbage collector and resets the slice to its \"zero value\". Empty slices are treated the same as \u003ccode\u003enil\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e arr \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token builtin\"\u003eint\u003c/span\u003e\narr \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token comment\"\u003e// evaluates to true\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eSince the \u003ccode\u003ehelper()\u003c/code\u003e method of the struct \u003ccode\u003eimpl2\u003c/code\u003e has the return type as \u003ccode\u003e[]*int\u003c/code\u003e, the \u003ccode\u003enil\u003c/code\u003e returned aquires the type \u003ccode\u003e[]*int\u003c/code\u003e with \"zero value\"\u003c/p\u003e\n\u003ch3 id=\"the-fix\"\u003e\u003ca class=\"anchor\" href=\"#the-fix\"\u003eThe Fix\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eThere are a couple of obvious fixes for this. The quick way is, The \u003ccode\u003efun()\u003c/code\u003e method of \u003ccode\u003eimpl1\u003c/code\u003e should not return \u003ccode\u003enil\u003c/code\u003e. Instead, it should return an empty slice.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003etype\u003c/span\u003e impl1 \u003cspan class=\"token keyword\"\u003estruct\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003ei impl1\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token function\"\u003efun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token keyword\"\u003einterface\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e arr \u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token builtin\"\u003eint\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003ereturn\u003c/span\u003e arr\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eAlternatively, you could also check if the value is nil before trying to typecast it.\u003c/p\u003e\n\u003cdiv class=\"remark-highlight\"\u003e\u003cpre class=\"language-go\"\u003e\u003ccode class=\"language-go\"\u003e\u003cspan class=\"token keyword\"\u003efunc\u003c/span\u003e \u003cspan class=\"token function\"\u003emain\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003evar\u003c/span\u003e A I\n\n  A \u003cspan class=\"token operator\"\u003e=\u003c/span\u003e impl1\u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  result \u003cspan class=\"token operator\"\u003e:=\u003c/span\u003e A\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003efun\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n  \u003cspan class=\"token keyword\"\u003eif\u003c/span\u003e result \u003cspan class=\"token operator\"\u003e==\u003c/span\u003e \u003cspan class=\"token boolean\"\u003enil\u003c/span\u003e \u003cspan class=\"token punctuation\"\u003e{\u003c/span\u003e\n    \u003cspan class=\"token comment\"\u003e// return an error or handle it any other way\u003c/span\u003e\n  \u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\n  fmt\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token function\"\u003ePrintln\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003eresult\u003cspan class=\"token punctuation\"\u003e.\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e(\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e[\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e]\u003c/span\u003e\u003cspan class=\"token operator\"\u003e*\u003c/span\u003e\u003cspan class=\"token builtin\"\u003eint\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\u003cspan class=\"token punctuation\"\u003e)\u003c/span\u003e\n\u003cspan class=\"token punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\u003cp\u003eThe \u003cstrong\u003eright way\u003c/strong\u003e, is to consider re-writing this part of the code. The interface should be given another thought.\u003c/p\u003e\n\u003ch3 id=\"lessons-learnt\"\u003e\u003ca class=\"anchor\" href=\"#lessons-learnt\"\u003eLessons learnt\u003c/a\u003e\u003c/h3\u003e\n\u003cp\u003eIt is very convenient to use \u003ccode\u003einterface{}\u003c/code\u003e where we want to \u003cstrong\u003eallow any type\u003c/strong\u003e. But it can cause a lot of unpredictable behavior. The empty interface is not a feature, it's a side effect of another feature which is the \u003cem\u003eimplicit implementation of interfaces\u003c/em\u003e. Since \u003ccode\u003einterface{}\u003c/code\u003e has no methods in it, every object in golang can conform to it.\u003c/p\u003e\n\u003cp\u003eSure, it can be useful when you want to \u003cstrong\u003eaccept any type\u003c/strong\u003e to be passed as an argument to a function (like in \u003ccode\u003efmt.Println\u003c/code\u003e and many others). It works out in this case because the treatment of the value passed is in the hands of the author of the function. If you are writing such a function, you would know exactly what kind of types to expect, and how to handle unexpected types. But when the function returns an empty \u003ccode\u003einterface{}\u003c/code\u003e, the user of the function has no idea of all the possible types that can come out. They will only know what type they expect and only handle that (leading to situations like the above).\u003c/p\u003e\n\u003cp\u003eThe \u003cstrong\u003eneed\u003c/strong\u003e to even return an empty interface exposes a design flaw in the code. In fact, returning \u003cstrong\u003eany interface\u003c/strong\u003e is probably not a good idea.\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003einterface{} says nothing\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eSee what \u003ca href=\"https://en.wikipedia.org/wiki/Rob_Pike\"\u003eRob Pike\u003c/a\u003e has to say about it (the video will start from a specific time, but watch the whole video when you get a chance):\u003c/p\u003e\n\u003cp\u003e{{\u0026#x3C; youtube \"PAAkCSZUG1c?start=455\" \u003e}}\n\u003cbr\u003e\u003c/p\u003e\n\u003cp\u003eSo, return a concrete type unless it's absolutely necessary to return an interface. In the above case, what could possibly be the reason to use an empty \u003ccode\u003einterface{}\u003c/code\u003e? \u003ccode\u003eimpl1\u003c/code\u003e and \u003ccode\u003eimpl2\u003c/code\u003e might return different types? Then, in that case, they shouldn't really conform to the same interface. There is almost always a way to \u003cstrong\u003enot\u003c/strong\u003e use an empty \u003ccode\u003einterface{}\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eHope this post was interesting. If you have any suggestions/corrections, consider \u003ca href=\"https://github.com/arjunmahishi/arjunmahishi.github.io/edit/master/content/posts/returning-interface-golang.md\"\u003emaking a PR\u003c/a\u003e :) or you can also slide into my \u003ca href=\"https://twitter.com/messages/131552332-131552332?text=hi\"\u003eTwitter DM\u003c/a\u003e\u003c/p\u003e\n\u003c/body\u003e\u003c/html\u003e","title":"Returning empty interfaces in Golang","date":"2022-01-08","tags":["golang","good-practices"]}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"empty-interfaces-golang"},"buildId":"uwdC6iWM-7ud-pXpO8LKL","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>