{"pageProps":{"postData":{"id":"empty-interfaces-golang","contentHTML":"<h1>Returning empty interfaces in Golang</h1>\n<p><img src=\"https://i.imgur.com/qX0N1Bg.png\" alt=\"returning-empty-interfaces-golang\"></p>\n<p>This week I ran into a bug with an empty <code>interface{}</code> which highlighted a smell in the code. This post describes what the bug is, how I fixed it, and the lessons learned.</p>\n<h3>The Bug</h3>\n<p>We found a couple of recovered panics in the logs. These panics were happening pretty frequently. This is what the panic message said:</p>\n<blockquote>\n<p>panic: interface conversion: interface {} is <code>nil</code>, not []*typeName</p>\n</blockquote>\n<p>From the panic message, it is pretty obvious that somewhere in the code we are trying to convert an <code>interface{}</code> to a specific array type when the value is actually <code>nil</code>. And the panic message also has a trace to the exact line where this conversion is taking place. This is a very common error and is easy to fix. But while debugging this, I encountered a smell in the code that led to this in the first place. This is what the code kind of looked like:</p>\n<p>There is an interface with a single method which returns <code>interface{}</code></p>\n<div class=\"remark-highlight\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">type</span> I <span class=\"token keyword\">interface</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">fun</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>There are two structs (<code>impl1</code> and <code>impl2</code>) that implement the above interface</p>\n<div class=\"remark-highlight\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// impl1 implements I</span>\n<span class=\"token keyword\">type</span> impl1 <span class=\"token keyword\">struct</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>i impl1<span class=\"token punctuation\">)</span> <span class=\"token function\">fun</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<div class=\"remark-highlight\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token comment\">// impl2 implements I</span>\n<span class=\"token keyword\">type</span> impl2 <span class=\"token keyword\">struct</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>i impl2<span class=\"token punctuation\">)</span> <span class=\"token function\">fun</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> i<span class=\"token punctuation\">.</span><span class=\"token function\">helper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>i impl2<span class=\"token punctuation\">)</span> <span class=\"token function\">helper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token builtin\">int</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">nil</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>What do you think will be the output of the below code?</p>\n<div class=\"remark-highlight\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> A<span class=\"token punctuation\">,</span> B I\n\n  A <span class=\"token operator\">=</span> impl1<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  B <span class=\"token operator\">=</span> impl2<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>A<span class=\"token punctuation\">.</span><span class=\"token function\">fun</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// statement 1</span>\n  fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>B<span class=\"token punctuation\">.</span><span class=\"token function\">fun</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// statement 2</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>As you can probably guess, <code>statement 1</code> panics and <code>statement 2</code> never gets executed. But what if <code>statement 1</code> wasn't there. What do you think would happen then?</p>\n<div class=\"remark-highlight\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> B I\n\n  B <span class=\"token operator\">=</span> impl2<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>B<span class=\"token punctuation\">.</span><span class=\"token function\">fun</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>Would this code panic?</p>\n<p>It wouldn't. This code actually prints <code>[]</code> (empty slice). This can be made more clear by printing the <code>type</code> of the return values.</p>\n<div class=\"remark-highlight\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> A<span class=\"token punctuation\">,</span> B I\n\n  A <span class=\"token operator\">=</span> impl1<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  B <span class=\"token operator\">=</span> impl2<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>reflect<span class=\"token punctuation\">.</span><span class=\"token function\">TypeOf</span><span class=\"token punctuation\">(</span>A<span class=\"token punctuation\">.</span><span class=\"token function\">fun</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// prints \"&#x3C;nil>\"</span>\n  fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>reflect<span class=\"token punctuation\">.</span><span class=\"token function\">TypeOf</span><span class=\"token punctuation\">(</span>B<span class=\"token punctuation\">.</span><span class=\"token function\">fun</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// prints \"[]*int\"</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>This is because when you assign <code>nil</code> to a slice in go, it releases the underlying array to the garbage collector and resets the slice to its \"zero value\". Empty slices are treated the same as <code>nil</code>.</p>\n<div class=\"remark-highlight\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">var</span> arr <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token builtin\">int</span>\narr <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token comment\">// evaluates to true</span>\n</code></pre></div>\n<p>Since the <code>helper()</code> method of the struct <code>impl2</code> has the return type as <code>[]*int</code>, the <code>nil</code> returned aquires the type <code>[]*int</code> with \"zero value\"</p>\n<h3>The Fix</h3>\n<p>There are a couple of obvious fixes for this. The quick way is, The <code>fun()</code> method of <code>impl1</code> should not return <code>nil</code>. Instead, it should return an empty slice.</p>\n<div class=\"remark-highlight\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">type</span> impl1 <span class=\"token keyword\">struct</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">func</span> <span class=\"token punctuation\">(</span>i impl1<span class=\"token punctuation\">)</span> <span class=\"token function\">fun</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">interface</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> arr <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token builtin\">int</span>\n  <span class=\"token keyword\">return</span> arr\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>Alternatively, you could also check if the value is nil before trying to typecast it.</p>\n<div class=\"remark-highlight\"><pre class=\"language-go\"><code class=\"language-go\"><span class=\"token keyword\">func</span> <span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> A I\n\n  A <span class=\"token operator\">=</span> impl1<span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  result <span class=\"token operator\">:=</span> A<span class=\"token punctuation\">.</span><span class=\"token function\">fun</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> result <span class=\"token operator\">==</span> <span class=\"token boolean\">nil</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// return an error or handle it any other way</span>\n  <span class=\"token punctuation\">}</span>\n\n  fmt<span class=\"token punctuation\">.</span><span class=\"token function\">Println</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">.</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">*</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>The <strong>right way</strong>, is to consider re-writing this part of the code. The interface should be given another thought.</p>\n<h3>Lessons learnt</h3>\n<p>It is very convenient to use <code>interface{}</code> where we want to <strong>allow any type</strong>. But it can cause a lot of unpredictable behavior. The empty interface is not a feature, it's a side effect of another feature which is the <em>implicit implementation of interfaces</em>. Since <code>interface{}</code> has no methods in it, every object in golang can conform to it.</p>\n<p>Sure, it can be useful when you want to <strong>accept any type</strong> to be passed as an argument to a function (like in <code>fmt.Println</code> and many others). It works out in this case because the treatment of the value passed is in the hands of the author of the function. If you are writing such a function, you would know exactly what kind of types to expect, and how to handle unexpected types. But when the function returns an empty <code>interface{}</code>, the user of the function has no idea of all the possible types that can come out. They will only know what type they expect and only handle that (leading to situations like the above).</p>\n<p>The <strong>need</strong> to even return an empty interface exposes a design flaw in the code. In fact, returning <strong>any interface</strong> is probably not a good idea.</p>\n<blockquote>\n<p>interface{} says nothing</p>\n</blockquote>\n<p>See what <a href=\"https://en.wikipedia.org/wiki/Rob_Pike\">Rob Pike</a> has to say about it (the video will start from a specific time, but watch the whole video when you get a chance):</p>\n<p>{{&#x3C; youtube \"PAAkCSZUG1c?start=455\" >}}\n<br></p>\n<p>So, return a concrete type unless it's absolutely necessary to return an interface. In the above case, what could possibly be the reason to use an empty <code>interface{}</code>? <code>impl1</code> and <code>impl2</code> might return different types? Then, in that case, they shouldn't really conform to the same interface. There is almost always a way to <strong>not</strong> use an empty <code>interface{}</code></p>\n<p>Hope this post was interesting. If you have any suggestions/corrections, consider <a href=\"https://github.com/arjunmahishi/arjunmahishi.github.io/edit/master/content/posts/returning-interface-golang.md\">making a PR</a> :) or you can also slide into my <a href=\"https://twitter.com/messages/131552332-131552332?text=hi\">Twitter DM</a></p>\n","title":"Returning empty interfaces in Golang","date":"2022-01-08","tags":["golang","good-practices"]}},"__N_SSG":true}